# üöÄ Production Deployment Guide - Librarity

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è Production –Ω–∞ VPS

### –ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

‚ùå **–ù–ï –ü–†–ê–í–ò–õ–¨–ù–û:**
```env
ENVIRONMENT=development
DEBUG=True
DB_ECHO=True
POLAR_SUCCESS_URL=http://localhost:3000/...
FRONTEND_URL=http://localhost:3005,https://librarity.1edu.kz
S3_ENDPOINT=http://164.90.180.120:9000
```

‚úÖ **–ü–†–ê–í–ò–õ–¨–ù–û:**
```env
ENVIRONMENT=production
DEBUG=False
DB_ECHO=False
POLAR_SUCCESS_URL=https://librarity.1edu.kz/subscription/success?checkout_id={CHECKOUT_ID}
FRONTEND_URL=https://librarity.1edu.kz
CORS_ORIGINS=https://librarity.1edu.kz

# MinIO (–≤–Ω–µ—à–Ω–∏–π S3)
MINIO_ENDPOINT=api.euroline.storage.1edu.kz
MINIO_ACCESS_KEY=–≤–∞—à-–∫–ª—é—á-–¥–æ—Å—Ç—É–ø–∞
MINIO_SECRET_KEY=–≤–∞—à-—Å–µ–∫—Ä–µ—Ç–Ω—ã–π-–∫–ª—é—á
MINIO_BUCKET_NAME=librarityl
MINIO_SECURE=True
```

---

## üìã –ü–æ—à–∞–≥–æ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ VPS DigitalOcean

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É

```bash
ssh root@164.90.180.120
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
sudo apt update && sudo apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python 3.11+
sudo apt install python3.11 python3.11-venv python3-pip python3.11-dev build-essential -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx
sudo apt install nginx -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
sudo apt install git curl certbot python3-certbot-nginx -y
```

### 3. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
mkdir -p /var/www/librarity
cd /var/www/librarity

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git clone https://github.com/bexiiiii/Librarity.git .
```

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Backend

```bash
cd /var/www/librarity/backend

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python3.11 -m venv venv
source venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install --upgrade pip
pip install -r requirements.txt
```

### 5. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ .env —Ñ–∞–π–ª–∞

```bash
nano /var/www/librarity/backend/.env
```

**–í—Å—Ç–∞–≤—å—Ç–µ (—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ –¥–ª—è production):**

```env
# APPLICATION SETTINGS
APP_NAME=Librarity
ENVIRONMENT=production
DEBUG=False
HOST=0.0.0.0
PORT=8000
API_V1_PREFIX=/api

# DATABASE
DATABASE_URL=postgresql+asyncpg://behruz:234Bex456@164.90.180.120:5432/librarity
DB_ECHO=False

# SECURITY
SECRET_KEY=d8bf5280a171e03905ce26de60621ea48fe52337d75b6747e5a52af00bd4bdd0
JWT_SECRET_KEY=d8bf5280a171e03905ce26de60621ea48fe52337d75b6747e5a52af00bd4bdd0
ENCRYPTION_KEY=d8bf5280a171e03905ce26de60621ea48fe52337d75b6747e5a52af00bd4bdd0
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7

# REDIS
REDIS_URL=redis://:super_secret_pass@164.90.180.120:6379/0
REDIS_HOST=164.90.180.120
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=super_secret_pass

# CELERY
CELERY_BROKER_URL=redis://:super_secret_pass@164.90.180.120:6379/1
CELERY_RESULT_BACKEND=redis://:super_secret_pass@164.90.180.120:6379/2

# QDRANT
QDRANT_URL=http://164.90.180.120:6333
QDRANT_API_KEY=
QDRANT_COLLECTION_NAME=librarity_books

# AI MODELS
GOOGLE_API_KEY=AIzaSyCuve5903CgmeMhEN5DFbSvlfwdfL9Os_Q
GEMINI_MODEL=gemini-2.0-flash-exp
GEMINI_EMBEDDING_MODEL=models/embedding-001

# POLAR.SH
POLAR_API_KEY=polar_oat_9OkMeWJ799ZgFycIhYJItqO68dy2cZtTslrxZ4JYxTP
POLAR_ORGANIZATION_ID=479a868b-9caa-4ee6-86a3-6c3a92696d1f
POLAR_WEBHOOK_SECRET=
POLAR_SANDBOX_MODE=true
POLAR_SERVER=sandbox
POLAR_SUCCESS_URL=https://librarity.1edu.kz/subscription/success?checkout_id={CHECKOUT_ID}

# TELEGRAM
TELEGRAM_BOT_TOKEN=8431190194:AAG8yf8V1wXKVYwfqMVkBjZRacB10php9Zo
TELEGRAM_ADMIN_CHAT_ID=6322824405

# MINIO (–í–ê–ñ–ù–û!)
USE_S3=True
MINIO_ENDPOINT=api.euroline.storage.1edu.kz
MINIO_ACCESS_KEY=–≤–∞—à-minio-access-key
MINIO_SECRET_KEY=–≤–∞—à-minio-secret-key
MINIO_BUCKET_NAME=librarityl
MINIO_SECURE=True

# CORS (–í–ê–ñ–ù–û!)
CORS_ORIGINS=https://librarity.1edu.kz
FRONTEND_URL=https://librarity.1edu.kz

# RATE LIMITING
RATE_LIMIT_PER_MINUTE=60
RATE_LIMIT_PER_HOUR=1000

# TOKEN LIMITS
FREE_TIER_TOKEN_LIMIT=10000
PRO_TIER_TOKEN_LIMIT=100000
ULTIMATE_TIER_TOKEN_LIMIT=300000

# BOOK PROCESSING
MAX_UPLOAD_SIZE_MB=50
CHUNK_SIZE=1000
CHUNK_OVERLAP=200

# LOGGING
LOG_LEVEL=INFO
LOG_FORMAT=json
```

**–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ:** Ctrl+O, Enter, Ctrl+X

### 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx (Reverse Proxy)

```bash
sudo nano /etc/nginx/sites-available/librarity-api
```

**–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:**

```nginx
server {
    listen 80;
    server_name api.librarity.1edu.kz;

    client_max_body_size 50M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–∏–≥)
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
        send_timeout 600;
    }
}
```

**–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:**

```bash
sudo ln -s /etc/nginx/sites-available/librarity-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 8. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

```bash
sudo certbot --nginx -d api.librarity.1edu.kz

# –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
sudo systemctl enable certbot.timer
```

### 9. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ FastAPI –∫–∞–∫ systemd service

```bash
# –°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤
sudo mkdir -p /var/log/fastapi
sudo chown -R www-data:www-data /var/log/fastapi

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ service —Ñ–∞–π–ª
sudo cp /var/www/librarity/backend/fastapi.service /etc/systemd/system/

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å
sudo systemctl daemon-reload
sudo systemctl enable fastapi
sudo systemctl start fastapi
sudo systemctl status fastapi
```

### 10. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Celery –∫–∞–∫ systemd service

```bash
# –°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
sudo mkdir -p /var/log/celery /var/run/celery
sudo chown -R www-data:www-data /var/log/celery /var/run/celery

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ service —Ñ–∞–π–ª
sudo cp /var/www/librarity/backend/celery.service /etc/systemd/system/

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ Celery
sudo systemctl daemon-reload
sudo systemctl enable celery
sudo systemctl start celery
sudo systemctl status celery
```

### 11. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall

```bash
sudo ufw allow 22/tcp      # SSH
sudo ufw allow 80/tcp      # HTTP
sudo ufw allow 443/tcp     # HTTPS
sudo ufw enable
sudo ufw status
```

### 12. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ FastAPI
curl http://localhost:8000/api/health
curl https://api.librarity.1edu.kz/api/health

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS
curl -I -X OPTIONS https://api.librarity.1edu.kz/api/auth/login \
  -H "Origin: https://librarity.1edu.kz" \
  -H "Access-Control-Request-Method: POST"

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
sudo journalctl -u fastapi -f
sudo journalctl -u celery -f
```

---

## üîÑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏

### FastAPI

```bash
sudo systemctl start fastapi      # –ó–∞–ø—É—Å–∫
sudo systemctl stop fastapi       # –û—Å—Ç–∞–Ω–æ–≤–∫–∞
sudo systemctl restart fastapi    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
sudo systemctl status fastapi     # –°—Ç–∞—Ç—É—Å
sudo journalctl -u fastapi -f     # –õ–æ–≥–∏
```

### Celery

```bash
sudo systemctl start celery       # –ó–∞–ø—É—Å–∫
sudo systemctl stop celery        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞
sudo systemctl restart celery     # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
sudo systemctl status celery      # –°—Ç–∞—Ç—É—Å
sudo journalctl -u celery -f      # –õ–æ–≥–∏
```

### Nginx

```bash
sudo systemctl restart nginx      # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
sudo systemctl status nginx       # –°—Ç–∞—Ç—É—Å
sudo nginx -t                     # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```

---

## üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞

```bash
cd /var/www/librarity
git pull origin main

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã
sudo systemctl restart fastapi
sudo systemctl restart celery
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

1. **MinIO –∫–ª—é—á–∏**: –ó–∞–º–µ–Ω–∏—Ç–µ `–≤–∞—à-minio-access-key` –∏ `–≤–∞—à-minio-secret-key` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ
2. **DNS**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `api.librarity.1edu.kz` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ `164.90.180.120`
3. **PostgreSQL**: –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 5432
4. **Redis**: –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 6379
5. **Qdrant**: –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 6333

---

## Pre-deployment Checklist

### ‚úÖ Code Optimization
- [x] Removed all test files (test_*.py, debug_*.py)
- [x] Removed old/unused components (UsersTab-old.tsx, polar_service_old.py)
- [x] Cleaned up console.log statements (handled by Next.js compiler)
- [x] Added .dockerignore files for optimized builds
- [x] Configured Next.js for production optimization
- [x] Added CORS configuration for production domain
- [x] Added MinIO integration for external S3 storage

### üîß Configuration Files Created
- `.env.production` - Production environment variables template
- `next.config.ts` - Optimized with compression, minification, and console removal
- `.dockerignore` - For both backend and frontend
- `fastapi.service` - Systemd service for FastAPI
- `celery.service` - Systemd service for Celery workers

## Production Optimizations Applied

### Frontend (Next.js)
```typescript
‚úÖ React Strict Mode enabled
‚úÖ Compression enabled
‚úÖ Image optimization (AVIF/WebP)
‚úÖ SWC minification
‚úÖ Console.log removal in production
‚úÖ CSS optimization
‚úÖ Package imports optimization (framer-motion, lucide-react)
‚úÖ Standalone output mode
‚úÖ Suspense boundaries for useSearchParams
```

### Backend (FastAPI)
```python
‚úÖ Debug files removed
‚úÖ Test files removed
‚úÖ Structured logging configured
‚úÖ Proper error handling
‚úÖ Production-ready logging
‚úÖ CORS configured for production domain
‚úÖ MinIO integration for file storage
‚úÖ PDF content validation
```

## Deployment Steps

### 1. Environment Setup

Copy and configure production environment:
```bash
cd backend
cp .env.production .env
# Edit .env with your production values
```

**Required Environment Variables:**
- `DATABASE_URL` - PostgreSQL connection string
- `SECRET_KEY` - Application secret (min 32 chars)
- `JWT_SECRET_KEY` - JWT signing key
- `OPENAI_API_KEY` - OpenAI API key
- `POLAR_API_KEY` - Polar.sh payment integration
- `REDIS_URL` - Redis for caching and Celery
- `RESEND_API_KEY` - Email service
- `AWS_*` - S3 credentials for file storage

### 2. Database Migration

```bash
cd backend
python scripts/apply_migration.py
```

### 3. Build Docker Images

#### Backend:
```bash
cd backend
docker build -f Dockerfile.prod -t librarity-backend:prod .
```

#### Frontend:
```bash
cd librarity
docker build -t librarity-frontend:prod .
```

### 4. Docker Compose Production

Use `docker-compose.prod.yml`:
```bash
docker-compose -f docker-compose.prod.yml up -d
```

### 5. Health Checks

After deployment, verify:
```bash
# Backend health
curl https://api.yourdomain.com/api/health

# Frontend
curl https://yourdomain.com
```

## Performance Optimizations

### 1. CDN Setup
- Deploy static assets to CDN
- Configure Next.js `assetPrefix` if needed

### 2. Database
- Enable connection pooling
- Set up read replicas for scaling
- Configure proper indexes

### 3. Redis
- Use Redis for session storage
- Enable Redis clustering for high availability

### 4. Monitoring

**Backend Monitoring:**
- Sentry for error tracking
- Prometheus metrics on port 9090
- Structured logging to centralized service

**Frontend Monitoring:**
- Next.js built-in analytics
- Sentry for client-side errors

### 5. Security

**SSL/TLS:**
```bash
# Use Let's Encrypt or similar
certbot --nginx -d yourdomain.com -d api.yourdomain.com
```

**Security Headers:**
- CSP (Content Security Policy)
- HSTS
- X-Frame-Options
- X-Content-Type-Options

### 6. Backup Strategy

**Database:**
```bash
# Daily automated backups
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d).sql
```

**Uploads:**
- Store in S3 with versioning enabled
- Enable S3 lifecycle policies

## Scaling Considerations

### Horizontal Scaling

**Backend:**
- Deploy multiple FastAPI instances behind load balancer
- Use gunicorn with multiple workers
- Scale Celery workers independently

**Frontend:**
- Deploy multiple Next.js instances
- Use nginx or cloud load balancer

### Vertical Scaling

**Recommended Specs:**
- **Small**: 2 CPU, 4GB RAM (up to 100 concurrent users)
- **Medium**: 4 CPU, 8GB RAM (up to 500 concurrent users)
- **Large**: 8 CPU, 16GB RAM (1000+ concurrent users)

## CI/CD Pipeline

### GitHub Actions Example:

```yaml
name: Deploy Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Build and Deploy
        run: |
          docker-compose -f docker-compose.prod.yml build
          docker-compose -f docker-compose.prod.yml up -d
```

## Troubleshooting

### Common Issues

1. **High memory usage**
   - Check for memory leaks in chat history
   - Implement pagination for large datasets
   - Configure proper connection pool sizes

2. **Slow API responses**
   - Enable Redis caching
   - Optimize database queries
   - Use CDN for static assets

3. **File upload issues**
   - Ensure S3 credentials are correct
   - Check file size limits in nginx/load balancer
   - Verify disk space on server

## Monitoring Commands

```bash
# Check logs
docker-compose -f docker-compose.prod.yml logs -f

# Check resource usage
docker stats

# Database connections
psql $DATABASE_URL -c "SELECT count(*) FROM pg_stat_activity;"

# Redis info
redis-cli info stats
```

## Rollback Procedure

```bash
# Stop current deployment
docker-compose -f docker-compose.prod.yml down

# Deploy previous version
git checkout previous-tag
docker-compose -f docker-compose.prod.yml up -d

# Restore database if needed
psql $DATABASE_URL < backup_previous.sql
```

## Support

For production issues:
1. Check application logs
2. Review Sentry errors
3. Monitor server metrics
4. Contact DevOps team

---

**Last Updated:** $(date +%Y-%m-%d)
**Production Readiness:** ‚úÖ READY
